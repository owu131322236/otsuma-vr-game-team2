<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Color Difference Search</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <link rel="stylesheet" href="stylesheet.css">
    
    <style>
        /* HTMLのメッセージボックスのスタイル */
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
        }
        #timer-display {
            position: absolute; 
            top: 10px; 
            right: 10px; 
            color: white; 
            background: rgba(0, 0, 0, 0.7); 
            padding: 5px; 
            border-radius: 5px; 
            z-index: 100;
            font-family: sans-serif;
        }
        body { margin: 0; overflow: hidden; }
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            color: white;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px; /* paddingを調整 */
            border-radius: 10px;
            z-index: 1000;
            display: none;
            text-align: center;
            font-size: 2em; /* フォントサイズを調整 */
        }
        .start-button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }
        .start-button:hover {
            background-color: #45a049; /* ホバー時の色 */
        }
        #timer-display {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 2em;
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body>
    <a-scene background="color: #e0ffff">

        <a-entity camera position="0 2 40" look-controls wasd-controls>
            <a-entity cursor="fuse: true; rayOrigin: mouse" 
                      raycaster="objects: .window; far: 50; interval: 1000; lineColor: red; lineOpacity: 0.8;"></a-entity>
        </a-entity>
        
        <a-entity laser-controls="hand: right" raycaster="objects: .window; far: 50; lineColor: red; lineOpacity: 0.8;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .window; far: 50; lineColor: red; lineOpacity: 0.8;"></a-entity>

        <a-box id="right-building" position="7 2.25 -3" scale="3 4.5 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="6 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="6 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="6 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>

        <a-box id="left-building" position="-7 3.75 -3" scale="3 7.5 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="-8 5 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 5 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 5 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 4 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 4 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 4 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 3 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>

        <a-box id="main-building" position="0 1.5 -3" scale="5 3 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="-1 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="0 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="1 2 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-1 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="0 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="1 1 -1.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>

        <a-box id="rooftop-structure" position="0 3.75 -3" scale="2 1.5 1.5" color="#C0C0C0"></a-box>
        <a-torus id="clock-face" position="0 3.75 -2.2" radius="0.5" radius-tubular="0.05" color="#B22222" rotation="0 0 0"></a-torus>
        
        <a-plane position="0 0 -3" rotation="-90 0 0" width="30" height="30" color="#808000"></a-plane>
    </a-scene>
    
    <div class="message-box" id="clear-message-box" style="display: none;">
        <p>Congratulations!</p>
    </div>

    <div class="message-box" id="game-over-message-box" style="display: none;">
        <p>Game Over…</p>
    </div>

    <div id="timer-display" style="display: none;">Remaining Time: <span id="time-left"></span>s</div>

    <script>
        // グローバルスコープでアクセスできるように変数と関数を定義
        let gameStarted = false;
        let timeLeft = 0;
        let timerInterval;

        const INITIAL_TIME = 30;
        const totalTargets = 5;

        // start-game-on-click コンポーネントは不要になったため削除

        $(function() {
            const windows = $('.window');
            // startSphereGroup の取得は不要になったため削除

            // 初期状態の設定
            $('#clear-message-box').hide();
            $('#game-over-message-box').hide();
            $('#timer-display').hide();
            // スタート用立体の表示/非表示制御は不要

            // ゲーム開始処理
            function startGame() {
                window.gameStarted = true;
                $('#game-over-message-box').hide();
                $('#clear-message-box').hide();
                $('#timer-display').show();
                
                // スタート用立体の非表示処理は不要

                // すべての窓を元の色にリセット
                windows.attr('color', '#4169E1');
                windows.removeClass('target-window'); 

                // ランダムに5つの窓を選ぶ
                let targetIndices = [];
                while (targetIndices.length < totalTargets) {
                    const randIndex = Math.floor(Math.random() * windows.length);
                    if (!targetIndices.includes(randIndex)) {
                        targetIndices.push(randIndex);
                    }
                }

                // 選ばれた窓に特別なクラスを追加
                targetIndices.forEach(i => {
                    windows.eq(i).addClass('target-window');
                });

                // タイマーをセット
                timeLeft = INITIAL_TIME;
                $('#time-left').text(timeLeft);
                clearInterval(timerInterval); 
                timerInterval = setInterval(function() {
                    timeLeft--;
                    $('#time-left').text(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        endGame(false); // ゲームオーバー
                    }
                }, 1000);
            }

            // 窓をクリックしたときのイベント
            $('.window').on('click', function(e) {
                if (!window.gameStarted) { 
                    return;
                }

                const $this = $(this);
                const currentColor = $this.attr('color');

                if ($this.hasClass('target-window')) {
                    $this.attr('color', '#FF4500'); // 窓を赤色にする
                    $this.removeClass('target-window'); 
                    checkAllWindowsClicked(); // クリックするたびにチェック
                } else if (currentColor === '#FF4500' || currentColor === '#FFD700') { 
                    $this.attr('color', '#4169E1'); // 窓を元の青色に戻す
                } else {
                    $this.attr('color', '#FFD700'); // 窓を金色にする
                }
            });

            // すべてのtarget-windowがクリックされたかどうかをチェックする関数
            function checkAllWindowsClicked() {
                if ($('.target-window').length === 0) {
                    clearInterval(timerInterval); 
                    endGame(true); // ゲームクリア
                }
            }

            // ゲーム終了処理 (クリア or ゲームオーバー)
            function endGame(isCleared) {
                window.gameStarted = false;
                $('#timer-display').hide(); 
                if (isCleared) {
                    $('#clear-message-box').show();
                    setTimeout(function() {
                        $('#clear-message-box').fadeOut();
                        // ゲームを再スタート（リセット）
                        startGame(); 
                    }, 3000); 
                } else {
                    $('#game-over-message-box').show(); 
                    setTimeout(function() {
                        $('#game-over-message-box').fadeOut();
                        // ゲームを再スタート（リセット）
                        startGame(); 
                    }, 3000); 
                }
            }
            
            // A-Frameのロード完了を待ってからゲームをスタート
            // A-Frameの要素（windows）を確実に操作するために、a-sceneの 'loaded' イベントを使用します。
            $('a-scene').on('loaded', function() {
                startGame();
            });

            // 念のため jQuery の DOM Ready でも実行しておく（保険として）
            // startGame();
            
            // 関数をグローバルスコープに設定（今回は外部からのアクセスは不要になりましたが、以前の慣習として残すこともできます）
            window.startGame = startGame;
            window.endGame = endGame;
        });
    </script>
</body>
</html>


