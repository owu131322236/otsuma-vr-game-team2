<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Color Difference Search</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    
    <style>
        /* HTMLのメッセージボックスのスタイル (VR外の環境向け。今回はボタンを使うため、主にVR要素を使用) */
        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <a-scene background="color: #e0ffff">
        <a-entity camera position="0 2 0" look-controls wasd-controls>
            <a-text id="vr-timer-display" 
                    value="Remaining Time: 60s" 
                    position="0 0.5 -1.5" 
                    width="2" 
                    align="center" 
                    color="#FFC107" 
                    visible="false">
            </a-text>

            <a-text id="vr-game-message" 
                    value="" 
                    position="0 0 -3" 
                    width="4" 
                    align="center" 
                    color="#FF0000" 
                    visible="false">
            </a-text>

            <a-entity cursor="fuse: true; rayOrigin: mouse" raycaster="objects: .window, #lobby-plane; far: 50; interval: 1000; lineColor: red; lineOpacity: 0.8;"></a-entity>
        </a-entity>

        <a-entity laser-controls="hand: right" raycaster="objects: .window, #lobby-plane; far: 50; lineColor: red; lineOpacity: 0.8;"></a-entity>
        <a-entity laser-controls="hand: left" raycaster="objects: .window, #lobby-plane; far: 50; lineColor: red; lineOpacity: 0.8;"></a-entity>
        
        <a-plane id="lobby-plane"
            position="0 0.9 -3"
            width="1.8" height="0.5"
            color="#4CAF50"
            visible="false">
        </a-plane>
        <a-text id="lobby-text" value="Return to Lobby"
            position="0 0.9 -2.9"
            align="center"
            color="#fff"
            width="5"
            visible="false">
        </a-text>

        <a-box id="right-building" position="7 2.25 -15" scale="3 4.5 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="6 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="6 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="6 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="7 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="8 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        
        <a-box id="left-building" position="-7 3.75 -15" scale="3 7.5 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="-8 5 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 5 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 5 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 4 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 4 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 4 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 3 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-8 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-7 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-6 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        
        <a-box id="main-building" position="0 1.5 -15" scale="5 3 2" color="#C0C0C0"></a-box>
        <a-box class="window" position="-1 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="0 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="1 2 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="-1 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="0 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        <a-box class="window" position="1 1 -13.9" scale="0.6 0.8 0.1" color="#4169E1"></a-box>
        
        <a-box id="rooftop-structure" position="0 3.75 -15" scale="2 1.5 1.5" color="#C0C0C0"></a-box>
        <a-torus id="clock-face" position="0 3.75 -14.2" radius="0.5" radius-tubular="0.05" color="#B22222" rotation="0 0 0"></a-torus>
        <a-plane position="0 0 -15" rotation="-90 0 0" width="30" height="30" color="#808000"></a-plane>
    </a-scene>
    
    <div class="message-box" id="clear-message-box" style="display: none;">
        <p>Congratulations!</p>
    </div>
    <div class="message-box" id="game-over-message-box" style="display: none;">
        <p>Game Over…</p>
    </div>

    <script>
        let gameStarted = false;
        let timeLeft = 0;
        let timerInterval;

        const INITIAL_TIME = 60;
        const totalTargets = 5;

        // A-Frameエンティティのキャッシュ
        const $vrTimerDisplay = $('#vr-timer-display');
        const $vrGameMessage = $('#vr-game-message');
        const $lobbyPlane = document.getElementById("lobby-plane");
        const $lobbyText = document.getElementById("lobby-text");

        $(function() {
            const windows = $('.window');

            // 1. 初期状態の設定
            $('#clear-message-box').hide();
            $('#game-over-message-box').hide();
            $vrTimerDisplay.attr('visible', false);
            $vrGameMessage.attr('visible', false);
            $lobbyPlane.setAttribute("visible", "false");
            $lobbyText.setAttribute("visible", "false");

            // 2. ロビーボタンのイベントリスナー設定
            // イベントリスナーはDOM Ready時に一度だけ設定します
            if ($lobbyPlane) {
                $lobbyPlane.addEventListener('click', () => {
                    window.location.href = "lobby.html"; 
                });
            }

            // 3. ゲーム開始処理
            function startGame() {
                window.gameStarted = true;
                // 初期化/リセット
                $vrGameMessage.attr('visible', false);
                $vrTimerDisplay.attr('visible', true); 
                $lobbyPlane.setAttribute("visible", "false");
                $lobbyText.setAttribute("visible", "false");
                
                // 窓のリセットとターゲット設定
                windows.attr('color', '#4169E1');
                windows.removeClass('target-window'); 

                let targetIndices = [];
                while (targetIndices.length < totalTargets) {
                    const randIndex = Math.floor(Math.random() * windows.length);
                    if (!targetIndices.includes(randIndex)) {
                        targetIndices.push(randIndex);
                    }
                }

                targetIndices.forEach(i => {
                    windows.eq(i).addClass('target-window');
                });

                // タイマーをセット
                timeLeft = INITIAL_TIME;
                $vrTimerDisplay.attr('value', `Remaining Time: ${timeLeft}s`); 
                clearInterval(timerInterval); 
                timerInterval = setInterval(function() {
                    timeLeft--;
                    $vrTimerDisplay.attr('value', `Remaining Time: ${timeLeft}s`);
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        endGame(false); // ゲームオーバー
                    }
                }, 1000);
            }

            // 4. 窓のクリックイベント
            $('.window').on('click', function(e) {
                if (!window.gameStarted) { 
                    return;
                }

                const $this = $(this);
                const currentColor = $this.attr('color');

                if ($this.hasClass('target-window')) {
                    $this.attr('color', '#FF4500'); 
                    $this.removeClass('target-window'); 
                    checkAllWindowsClicked(); 
                } else if (currentColor === '#FF4500' || currentColor === '#FFD700') { 
                    $this.attr('color', '#4169E1'); 
                } else {
                    $this.attr('color', '#FFD700'); 
                }
            });

            // 5. ゲームクリア判定
            function checkAllWindowsClicked() {
                if ($('.target-window').length === 0) {
                    clearInterval(timerInterval); 
                    endGame(true); // ゲームクリア
                }
            }

            // 6. ゲーム終了処理 (クリア or ゲームオーバー)
            function endGame(isCleared) {
                window.gameStarted = false;
                $vrTimerDisplay.attr('visible', false); // VRタイマーを非表示に

                const message = isCleared ? "Congratulations!" : "Game Over...";
                const color = isCleared ? "#00FF00" : "#FF0000";

                // VR空間内のメッセージを表示
                $vrGameMessage.attr('value', message);
                $vrGameMessage.attr('color', color);
                $vrGameMessage.attr('visible', true);

                // HTMLメッセージボックスは非表示 (今回はVRボタンがメインのため)
                $('#clear-message-box').hide(); 
                $('#game-over-message-box').hide(); 

                // ロビーボタンとテキストを表示
                $lobbyPlane.setAttribute("visible", "true");
                $lobbyText.setAttribute("visible", "true");
                
                // VRメッセージは3秒後に非表示にする（ボタンと共存させるため）
                setTimeout(() => {
                    $vrGameMessage.setAttribute('visible', false);
                }, 3000); 
            }

            // A-Frameのシーンロード完了後にゲームを開始
            $('a-scene').on('loaded', function() {
                startGame();
            });

            window.startGame = startGame;
            window.endGame = endGame;
        });
    </script>
</body>
</html>

