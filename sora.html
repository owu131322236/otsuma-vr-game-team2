<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.8thwall.com/web/aframe/ammo.wasm.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/n5ro/aframe-physics-system@v4.0.1/dist/aframe-physics-system.min.js"></script>
</head>
<body>

  <a-scene physics="driver: ammo ; gravity: -0.6" >

    <a-sky color="#ABE1FA"></a-sky>
    
    <a-entity id="rig">
      <a-camera></a-camera>
    </a-entity>

    
    <a-entity laser-controls="hand: right"
    		  cursor="fuse: false"
    		  raycaster="objects: .clickable-ball, .clickable; far: 5; near: 0.05; lineColor: red; linewidth: 3; lineOpacity: 0.8;">
    </a-entity>
    
    <a-cylinder
      id="trampoline"
      position="0 0 -5"
      radius="1.5"
      height="0.01"
      rotation="10 0 0"
      ammo-body="type: static; emitCollisionEvents: true"
      ammo-shape="type: cylinder"
    >
      <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
      <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
      <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
      <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
      <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
      <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
      <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
      <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
      <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
      <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
      <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
      <a-sphere radius="1.5" color="#ffffff" opacity="0.9" transparent="true"></a-sphere>
    </a-cylinder>

	<a-entity position="-7 6 -16" scale="2 2 2">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>

	<a-entity position="8 12 -18" scale="1.8 1.8 1.8">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>
	
	<a-entity position="12 3 -16" scale="1.8 1.8 1.8">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>
	
	<a-entity position="-17 -7 -18" scale="1.8 1.8 1.8">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>

	<a-entity position="19 -8 -18" scale="1.8 1.8 1.8">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>
	
	<a-entity position="-19 13 -18" scale="1.8 1.8 1.8">
	    <a-sphere radius="1.2" position="0 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.2" position="-1.2 0 0" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.1" position="-0.8 0.5 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="1.0" position="0 0.6 -0.6" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="1.5 0.4 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.6" position="-1.5 0.3 0.2" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="-0.5 0.8 -0.5" color="#ffffff"></a-sphere>
	    <a-sphere radius="0.5" position="0 0.9 -0.4" color="#ffffff"></a-sphere>
	</a-entity>

	    <a-text id="final-score" value="" position="0 2 -3" align="center" color="#ff69b4" visible="false" width="6"></a-text>
	    <a-text id="score" value="Score: 0" position="-2 2 -3" color="black"></a-text>
	    <a-text id="timer" value="Time: 30" position="1.2 2 -3" color="black"></a-text>

    <!-- 終了ボタン -->
    <a-sphere 
        id="end-button"  
        position="0 1.2 -2" 
        radius="0.4"
        color="#ffc0cb"
        material="shader: standard; roughness: 1; metalness: 0; opacity: 0.9; transparent: true; envMapIntensity: 0.3;"
        animation__hover="property: scale; startEvents: mouseenter; to: 1.2 1.2 1.2; dur: 300;"
        animation__leave="property: scale; startEvents: mouseleave; to: 1 1 1; dur: 300;"
        animation__click="property: scale; startEvents: click; to: 0.8 0.8 0.8; dur: 150; dir: alternate;"
        visible="false">
        </a-sphere>

    <!-- ボタン上の文字 -->
    <a-text 
        id="end-text"
        value="Lobby" 
        position="0 1.2 -1.6" 
        align="center" 
        color="#555" 
        visible="false"
        font="https://cdn.aframe.io/fonts/DejaVu-sdf.fnt"
        ></a-text>
	  </a-scene>

  <script>
    const scene = document.querySelector("a-scene");
    
    // ゲーム終了ボタンを取得
    const endButton = document.getElementById("end-button");
    const endText = document.getElementById("end-text");
    
    // 安全策：最初はクリック不可
	endButton.classList.remove("clickable");
	
	
    const trampoline = document.querySelector("#trampoline");

    trampoline.addEventListener("body-loaded", () => {
      trampoline.body.setRestitution(1.3);
    });

    trampoline.addEventListener("collide", (e) => {
      const ball = e.detail.body.el;
      if (!ball || ball.tagName.toLowerCase() !== "a-sphere") return;

      const range = 0.4; 
      const offsetX = (Math.random() - 0.5) * range;
      const targetX = offsetX;
      const targetZ = 1;

      const pos = ball.getAttribute("position");
      ball.setAttribute("position", `${targetX} ${pos.y} ${targetZ}`);

      const velocityY = 1.5;
      ball.body.setLinearVelocity(new Ammo.btVector3(0, velocityY, 0));
      ball.body.setAngularVelocity(new Ammo.btVector3(0, 0, 0));
    });

    let score = 0;
    let droppedBalls = 0;
    
    
    
    let clickedBalls = 0; 

    const totalBalls = 29;
    const scoreDisplay = document.getElementById("score");
    const finalScoreDisplay = document.getElementById("final-score");
    
    function checkGameEnd() {
      if (droppedBalls >= totalBalls) {
        finalScoreDisplay.setAttribute("value", `Score: ${score}`);
        finalScoreDisplay.setAttribute("visible", "true");
      }
    }
    
    function getRandomPastelColor() {
      const hue = Math.floor(Math.random() * 360);
      return `hsl(${hue}, 70%, 80%)`;
    }
	function dropSphere(i) {
	  let sphere = document.createElement("a-sphere");
	  sphere.setAttribute("ammo-body", "type: dynamic; emitCollisionEvents: true; ccdMotionThreshold: 1; ccdSweptSphereRadius: 0.2");
	  sphere.setAttribute("ammo-shape", "type: sphere");
	  sphere.setAttribute("radius", "0.25");

	  let randomColor = getRandomPastelColor();
	  sphere.setAttribute("color", randomColor);
	  sphere.setAttribute("class", "clickable-ball");
	  sphere.setAttribute("cursor-listener", ""); 
	  
	  let isGoldBall = (i === Math.floor(Math.random() * totalBalls)) || (i === Math.floor(Math.random() * totalBalls));
	  
		
    //金色
  //if (isGoldBall) {
  //   sphere.setAttribute("color", "gold"); 
  //   sphere.setAttribute("data-special", "gold");
  // } else {
  //   let randomColor = getRandomPastelColor();
  //   sphere.setAttribute("color", randomColor);
  // }

    if (isGoldBall) {
      sphere.setAttribute("data-special", "gold");
      sphere.setAttribute("material", {
        color: "#FFFACD",           // 濃い金色（DarkGoldenRod）
        metalness: 0.8,             // より金属的に
        roughness: 0.2,             // 反射を強く
        emissive: "#FFD700",        // 金色に近い発光
        emissiveIntensity: 0.5      // 発光を強めてリッチな輝きに
      });
    } else {
      let randomColor = getRandomPastelColor();
      sphere.setAttribute("color", randomColor);
    }

	  let randomX = Math.random() * 3 - 1.5;
	  sphere.setAttribute("position", `${randomX} 5 -5`);

	  sphere.addEventListener("body-loaded", () => {
	    sphere.body.setRestitution(0.7);
	    droppedBalls++;
	    //setTimeout(checkGameEnd, 4000); 
	  });

	  scene.appendChild(sphere);
	}
	AFRAME.registerComponent("cursor-listener", {
	  init: function () {
	    this.el.addEventListener("click", () => {
	     
	      if (this.el.getAttribute("data-scored")) return;

	      if (this.el.getAttribute("data-special") === "gold") {
        score += 5;
      } else {
        score++;
      }
	      
	      clickedBalls++;
	      
	      scoreDisplay.setAttribute("value", `Score: ${score}`);
	      this.el.setAttribute("data-scored", "true");

	      //this.el.setAttribute("color", "#FF69B4"); 
	      this.el.setAttribute("color", "#00bfff"); 
	      
	      
		      
	      
	      
	      if (clickedBalls === totalBalls && droppedBalls === totalBalls) {
			  finalScoreDisplay.setAttribute("value", `Score: ${score}`);
			  finalScoreDisplay.setAttribute("visible", true);
			}
			
                const textEntity = document.createElement('a-entity');
                textEntity.setAttribute('position', '0 0 0.5'); 
                textEntity.setAttribute('text', {
                    value: 'hit!',
                    align: 'center',
                    color: 'blue',
                    width: 5,
                });
                textEntity.setAttribute('scale', '0 0 0'); 
                this.el.appendChild(textEntity);

        
                textEntity.setAttribute('animation', {
                    property: 'scale',
                    to: '1 1 1',
                    dur: 200,
                    easing: 'easeInQuad'
                });

                
                setTimeout(() => {
                    textEntity.setAttribute('animation', {
                        property: 'scale',
                        to: '0 0 0',
                        dur: 300,
                        easing: 'easeOutQuad'
                    });
                    setTimeout(() => {
                        this.el.removeChild(textEntity);
                    }, 300);
                }, 1000); 
                
	    });
	  }
	});
	
	let timeLeft = 30; 

	const timerDisplay = document.getElementById("timer");

	const timerInterval = setInterval(() => {
	  timeLeft--;
	  timerDisplay.setAttribute("value", `Time: ${timeLeft}`);
	  
	  if (timeLeft <= 3) {
	    timerDisplay.setAttribute("color", "red");
	  } else {
	    timerDisplay.setAttribute("color", "black");
	  }	  
	  
	  if (timeLeft <= 0) {
	    clearInterval(timerInterval);
	    endGame();
	  }
	}, 1000);
	
	// function endGame() {
	//   finalScoreDisplay.setAttribute("value", `Score: ${score}`);
	//   finalScoreDisplay.setAttribute("visible", true);
	// }
    function endGame() {
    finalScoreDisplay.setAttribute("value", `Score: ${score}`);
    finalScoreDisplay.setAttribute("visible", true);

    // Dobiiに戻るボタンを表示
    endButton.setAttribute("visible", true);
    endText.setAttribute("visible", true);
    
     // クリック対象に追加
  	endButton.classList.add("clickable");
    }

	function checkGameEnd() {
	  if (clickedBalls === totalBalls && droppedBalls === totalBalls) {
	    clearInterval(timerInterval);
	    endGame(); 
	  }
	}
	
	
    for (let i = 0; i < 29; i++) {
      setTimeout(() => dropSphere(i), i * 1000);
    }

    // クリックでlobby.html
    endButton.addEventListener("click", () => {
        const isVisible = endButton.getAttribute("visible");
        if (isVisible) {
            window.location.href = "lobby.html";
        }
    });

  </script>
</body>
</html>
